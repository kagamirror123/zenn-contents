---
title: "Cloudformationãƒ„ãƒ¼ãƒ«ï¼šrainã®ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰ã¨è¨˜æ³•"
emoji: "â˜”ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Cloudformation,Rain,AWS]
published: true
---

# æ¦‚è¦

rainã§åˆ©ç”¨ã§ãã‚‹ã€ã€Œã‚ã¾ã‚Šå­˜åœ¨ã‚’çŸ¥ã‚‰ã‚Œã¦ã„ãªãã†ã ã‘ã©ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰ã‚„è¨˜æ³•ã€ã«ã¤ã„ã¦ä¸€éƒ¨ç´¹ä»‹ã—ã¾ã™ã€‚

rainã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®è¨˜äº‹ãŒå¤§å¤‰ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
[rain: CloudFormation ã‚’ä¾¿åˆ©ã«æ“ä½œã—ã¡ã‚ƒãŠã† \- kakakakakku blog](https://kakakakakku.hatenablog.com/entry/2023/05/05/110658)

## rainã«ã¤ã„ã¦

rainã¯ã€AWS CloudFormationã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç°¡ç´ åŒ–ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’åŠ¹ç‡çš„ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
https://github.com/aws-cloudformation/rain


# ã‚³ãƒãƒ³ãƒ‰

ä»Šå›åˆ©ç”¨ã™ã‚‹Cloudformationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```yaml:template.yaml
AWSTemplateFormatVersion: 2010-09-09

Description: Generated by rain

Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: kagamirror-2024-09-26
```

## ls

é€šå¸¸ rain deploy ã®éš›ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ã‚¿ãƒƒã‚¯ã®å·®åˆ†ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã‚Œã ã¨ã€ŒS3ãƒã‚±ãƒƒãƒˆã«ä½•ã‚‰ã‹ã®å¤‰æ›´ãŒã‚ã‚‹ã€ã“ã¨ã¯åˆ†ã‹ã£ã¦ã‚‚ã€ã€ŒS3ãƒã‚±ãƒƒãƒˆã«ã©ã‚“ãªå¤‰æ›´ãŒã‚ã£ãŸã‹ã€ã¾ã§ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/48e39cd7cd6e-20240926.png)

ãã“ã§ã€`ls --changeset`ã‚’ä½¿ã†ã“ã¨ã§å·®åˆ†ã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```console
# --no-execã§ãƒã‚§ãƒ³ã‚¸ã‚»ãƒƒãƒˆã®ä½œæˆã¾ã§ã«ç•™ã‚ã¦ãŠã
output=$(rain deploy template.yaml kagamirror-test --no-exec --yes)

# ãƒã‚§ãƒ³ã‚¸ã‚»ãƒƒãƒˆIDã‚’å–å¾—
changeset_id=$(echo "$output" | grep 'not executed: ' | awk -F ': ' '{print $2}')

# ãƒã‚§ãƒ³ã‚¸ã‚»ãƒƒãƒˆã‚’ç¢ºèª
rain ls -c kagamirror-test ${changeset_id}
```

before/afterãŒè¡¨ç¤ºã•ã‚Œã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã§å·®åˆ†ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/2308d9dd934f-20240926.png)

å·®åˆ†ãŒå•é¡Œãªã‘ã‚Œã°ã€`rain deploy --changeset`ã§ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°OK

## forecast

ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®å¯èƒ½æ€§ã«é–¢ã™ã‚‹è­¦å‘Šã‚’å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

åŒã˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã‚¹ã‚¿ãƒƒã‚¯åã ã‘å¤‰ãˆã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¾ã™ã€‚

```console
> rain forecast --experimental template.yaml kagamirror-test-2

Stormy weather ahead! ğŸŒª

1 checks failed out of 1 total checks
FG001 FAIL on line 6: AWS::S3::Bucket Bucket - Resource with this name already exists
```

ã™ã§ã«å­˜åœ¨ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆåã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ãŸã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã—ã¦ãã‚Œã¾ã—ãŸã€‚
ã“ã®ç¨‹åº¦ã§ã‚ã‚Œã°ã‚ã–ã‚ã–forecastã™ã‚‹ã¾ã§ã‚‚ãªã„ã§ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã«æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆãªã©ã¯å½¹ç«‹ã¡ãã†ãªã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

## logs

rain logs ã¯ã‚¹ã‚¿ãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™

```console
â¯ rain logs kagamirror-test --all

Sep 26 08:17:36 kagamirror-test/Bucket (AWS::S3::Bucket) CREATE_COMPLETE
Sep 26 08:17:36 kagamirror-test/kagamirror-test (AWS::CloudFormation::Stack) CREATE_COMPLETE
Sep 26 08:17:23 kagamirror-test/Bucket (AWS::S3::Bucket) CREATE_IN_PROGRESS "Resource creation Initiated"
Sep 26 08:17:21 kagamirror-test/Bucket (AWS::S3::Bucket) CREATE_IN_PROGRESS
Sep 26 08:17:19 kagamirror-test/kagamirror-test (AWS::CloudFormation::Stack) CREATE_IN_PROGRESS "User Initiated"
Sep 26 08:12:28 kagamirror-test/kagamirror-test (AWS::CloudFormation::Stack) REVIEW_IN_PROGRESS "User Initiated"
```

`--chart`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚¹ã‚¿ãƒƒã‚¯ã®å„ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‹ã‹ã£ãŸæ™‚é–“ã‚’ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã§è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
rain logs --chart kagamirror-test > gantchart.html
```

![](https://storage.googleapis.com/zenn-user-upload/1a847134fce0-20240926.png)

# è¨˜æ³•

## !Rain::Embed

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€ã“ã¨ã®å‡ºæ¥ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã™ã€‚

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒã˜éšå±¤ã«`index.py`ã‚’ä½œæˆã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§åŸ‹ã‚è¾¼ã¿ãŒã§ãã¾ã™ã€‚

```shell
.
â”œ index.py
â”” template.yaml
```

```python:index.py
def handler_name(event, context): 
    print("Hello World")
    return "ok"
```

```yaml:template.yaml
AWSTemplateFormatVersion: 2010-09-09

Description: Generated by rain

Resources:
  TestLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: test-lambda
      Role: arn:aws:iam::xxxxxxxxxxx:role/AWSLambdaBasicExecutionRole
      Runtime: python3.12
      Handler: index.lambda_handler
      Code:
        ZipFile: !Rain::Embed index.py
```

## !Rain::Include

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆ¥ã®yamlã‚’includeã™ã‚‹ã“ã¨ã®ã§ãã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã™ã€‚
è‚¥å¤§åŒ–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç­‰ã§é©åˆ‡ãªç²’åº¦ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã‚‹ã¨è¦‹é€šã—ãŒè‰¯ããªã‚Šãã†ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ã„ã¾ã™ã€‚

```shell
.
â”œ s3.yaml
â”œ lambda.yaml
â”œ index.py
â”” template.yaml
```

```yaml:s3.yaml
Type: AWS::S3::Bucket
Properties:
  BucketName: kagamirror-2024-09-26
```

```yaml:lambda.yaml
Type: AWS::Lambda::Function
Properties:
  FunctionName: test-lambda
  Role: arn:aws:iam::xxxxxxxxxxx:role/AWSLambdaBasicExecutionRole
  Runtime: python3.12
  Handler: index.lambda_handler
  Code:
    ZipFile: !Rain::Embed index.py
```

```yaml:template.yaml
AWSTemplateFormatVersion: 2010-09-09

Description: Generated by rain

Resources:
  TestS3:
    !Rain::Include s3.yaml
  TestLambda:
    !Rain::Include lambda.yaml
```

## !Rain::S3Http / !Rain:S3

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§æŒ‡å®šã•ã‚ŒãŸãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒ Rain CLI ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã« S3 ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ãã® HTTPS URL ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ä½¿ç”¨ã§ãã¾ã™ã€‚
ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã®S3ã®ã“ã¨ã‚’è€ƒãˆãªãã¦ã‚ˆã„ã®ã§éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã® S3 ãƒã‚±ãƒƒãƒˆã¯ rain ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã‚‹ãƒã‚±ãƒƒãƒˆã§ã™ã€‚ï¼ˆ`rain-artifacts-<AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆID>-<AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³>`ã¨ã„ã†è¦å‰‡ã§ä½œæˆã•ã‚Œã¾ã™ã€‚ï¼‰

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®é•ã„

- !Rain::S3Http : `https://`ã‹ã‚‰å§‹ã¾ã‚‹URLãŒè¿”ã£ã¦ãã‚‹
- !Rain:S3 : `s3:://`ã‹ã‚‰å§‹ã¾ã‚‹S3URLãŒè¿”ã£ã¦ãã‚‹


### å˜ç´”ã«æŒ‡å®šã™ã‚‹å ´åˆ

```yaml:S3Httpã‚’ä½¿ç”¨ã™ã‚‹ä¾‹
Resources:
  NestedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Rain::S3Http templates/child-stack.yaml
```

```yaml:S3ã‚’ä½¿ç”¨ã™ã‚‹ä¾‹
Resources:
  MySageMakerModel:
    Type: AWS::SageMaker::Model
    Properties:
      PrimaryContainer:
        Image: <ECR Image URI>
        ModelDataUrl: !Rain::S3 model/model.tar.gz
```


### ãƒã‚±ãƒƒãƒˆã‚„ã‚­ãƒ¼ã‚’åˆ†ã‘ã¦æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ

ä»¥ä¸‹ã¯ã€API Gateway ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä¾‹ã§ã™ã€‚
ãƒã‚±ãƒƒãƒˆåã¨ã‚­ãƒ¼åã‚’ãã‚Œãã‚Œå€‹åˆ¥ã«æŒ‡å®šã™ã‚‹å¿…è¦ã®ã‚ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Path, Zip, BucketProperty, KeyPropertyã«åˆ†è§£ã—ã¦æ›¸ãå¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

```yaml:template.yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: '!Rain::S3Http ã‚’ä½¿ç”¨ã—ãŸ API Gateway ã®ä¾‹'

Resources:
  MyApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: MyAPI
      BodyS3Location: !Rain::S3
        Path: api-definition.yaml
        Zip: false
        BucketProperty: Bucket
        KeyProperty: Key
```

```yaml:rain deploy --debug ã§ç¢ºèªã§ãã‚‹å±•é–‹å¾Œã®yaml
AWSTemplateFormatVersion: "2010-09-09"

Description: '!Rain::S3Http ã‚’ä½¿ç”¨ã—ãŸ API Gateway ã®ä¾‹'

Resources:
  MyApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: MyAPI
      BodyS3Location:
        Bucket: rain-artifacts-xxxxxxxxxxxxxx-us-west-2
        Key: 2944a86b8861de0ae0c1f7exxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## Parameters / Tags

rainã§ã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®yamlã«å®šç¾©ã—ãŸ`Parameters`ã¨`Tags`ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã®éš›ã«èª­ã¿è¾¼ã‚€ã“ã¨ãŒå‡ºæ¥ã‚‹ã€‚

ç’°å¢ƒã”ã¨ã«èª­ã¿è¾¼ã¾ã›ãŸã„`parameters.yaml`ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§æŸ”è»Ÿãªé‹ç”¨ãŒå¯èƒ½ã«ãªã‚‹ã€‚

```yaml:parameters.dev.yaml
Parameters:
  ParamA: aaa
  ParamB: bbb

Tags:
  Environment: dev
```

```shell
rain deploy template.yaml <stack_name> --config parameters.dev.yaml
```

:::message
ã“ã“ã§å®šç¾©ã•ã‚ŒãŸTagsã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒ¬ãƒ™ãƒ«ã§ä»˜ä¸ã•ã‚Œã‚‹ã‚¿ã‚°ãªã®ã§ã€åŸºæœ¬çš„ã«ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ä»˜ä¸ã•ã‚Œã‚‹ã€‚

ãŒã€`AWS::DAX::Cluster`ã®ã‚ˆã†ã«Mapå½¢å¼ã§ã‚¿ã‚°ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã®ã‚ã‚‹ä¸€éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ã¯ã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œãªã„ã®ã§æ³¨æ„ã€‚

```yaml
DAX:
  Type: AWS::DAX::Cluster
  Properties: 
  Tags:
    Project:
    Environment:
```
:::